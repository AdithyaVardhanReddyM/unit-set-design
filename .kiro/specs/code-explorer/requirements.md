# Requirements Document

## Introduction

The Code Explorer feature enables users to browse and view the source code of AI-generated UI components directly within the AI Sidebar. When users click on the "Code" tab, the sidebar expands to occupy half the screen width, revealing a split-panel interface with a file explorer on the left and a code viewer on the right. The feature uses an on-demand fetching strategy to retrieve file system structure and file contents from the E2B sandbox, optimizing for performance by only loading data when needed.

## Glossary

- **E2B Sandbox**: An isolated Linux-based execution environment where the AI agent generates and runs Next.js code. The project root is `/home/user`.
- **Code Explorer**: The expanded sidebar interface that displays the file tree and code viewer.
- **File Tree**: A hierarchical representation of folders and files in the sandbox.
- **Code Viewer**: A panel that displays the contents of a selected file with syntax highlighting.
- **On-Demand Fetching**: A strategy where file system data is fetched only when the user requests it (e.g., clicking a folder or file).
- **Cached Files**: Files already stored in the Convex `screens.files` field from AI tool calls, which can be displayed without fetching from the sandbox.
- **Sandbox Session**: An active E2B sandbox instance identified by `sandboxId`.

## Requirements

### Requirement 1

**User Story:** As a user, I want to view the code generated by the AI, so that I can understand and learn from the implementation.

#### Acceptance Criteria

1. WHEN a user clicks the "Code" tab in the AI Sidebar THEN the Code Explorer SHALL expand the sidebar to approximately 50% of the viewport width
2. WHEN the Code Explorer is displayed THEN the Code Explorer SHALL show a split-panel layout with a file tree on the left (approximately 30% width) and a code viewer on the right (approximately 70% width)
3. WHEN the Code Explorer is closed by switching tabs THEN the Code Explorer SHALL collapse the sidebar back to its original width (340px)
4. WHEN the Code Explorer is displayed THEN the Code Explorer SHALL apply a smooth animation transition for the width change

### Requirement 2

**User Story:** As a user, I want to browse the file structure of my generated project, so that I can navigate to specific files.

#### Acceptance Criteria

1. WHEN the Code Explorer opens THEN the Code Explorer SHALL fetch and display the root-level contents of `/home/user` from the sandbox
2. WHEN a user clicks on a collapsed folder THEN the Code Explorer SHALL fetch and display the contents of that folder
3. WHEN a user clicks on an expanded folder THEN the Code Explorer SHALL collapse that folder and hide its contents
4. WHEN folder contents are being fetched THEN the Code Explorer SHALL display a loading indicator on that folder
5. WHEN a folder fetch fails THEN the Code Explorer SHALL display an error state with a retry option
6. WHEN displaying folder contents THEN the Code Explorer SHALL sort items with folders first, then files, both in alphabetical order
7. WHEN displaying file and folder names THEN the Code Explorer SHALL show appropriate icons based on file type (folder, TypeScript, JavaScript, JSON, CSS, etc.)

### Requirement 3

**User Story:** As a user, I want to view the contents of a file, so that I can read and understand the code.

#### Acceptance Criteria

1. WHEN a user clicks on a file in the file tree THEN the Code Explorer SHALL display the file contents in the code viewer panel
2. WHEN the file content exists in the cached files (from AI tool calls) THEN the Code Explorer SHALL display the cached content without fetching from the sandbox
3. WHEN the file content does not exist in cache THEN the Code Explorer SHALL fetch the content from the sandbox using the file path
4. WHEN file content is being fetched THEN the Code Explorer SHALL display a loading state in the code viewer
5. WHEN a file fetch fails THEN the Code Explorer SHALL display an error message with a retry option
6. WHEN displaying file content THEN the Code Explorer SHALL apply syntax highlighting based on the file extension
7. WHEN a file is selected THEN the Code Explorer SHALL visually highlight the selected file in the file tree

### Requirement 4

**User Story:** As a user, I want the Code Explorer to handle edge cases gracefully, so that I have a reliable experience.

#### Acceptance Criteria

1. WHEN no screen is selected THEN the Code Explorer SHALL display a message prompting the user to select a screen
2. WHEN the selected screen has no sandbox session THEN the Code Explorer SHALL display a message indicating no code is available yet
3. WHEN the sandbox session has expired or is unavailable THEN the Code Explorer SHALL display an appropriate error message
4. WHEN the file tree is empty THEN the Code Explorer SHALL display an empty state message
5. IF the sandbox connection fails THEN the Code Explorer SHALL provide a clear error message and suggest the user try again later

### Requirement 5

**User Story:** As a user, I want to copy code from the viewer, so that I can use it in my own projects.

#### Acceptance Criteria

1. WHEN viewing file content THEN the Code Explorer SHALL provide a copy button to copy the entire file content
2. WHEN the copy button is clicked THEN the Code Explorer SHALL copy the file content to the clipboard and show a success indicator
3. WHEN displaying code THEN the Code Explorer SHALL allow text selection for partial copying

### Requirement 6

**User Story:** As a user, I want the Code Explorer to remember my navigation state, so that I can continue where I left off.

#### Acceptance Criteria

1. WHEN switching between tabs (Chat, Edit, Code) THEN the Code Explorer SHALL preserve the expanded folder state
2. WHEN switching between tabs THEN the Code Explorer SHALL preserve the currently selected file
3. WHEN the screen selection changes THEN the Code Explorer SHALL reset the file tree and code viewer state
